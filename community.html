<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒåŸåŠ¨æ€ - PawPals</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- åŠ è½½Supabaseåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- åŠ è½½Supabaseé…ç½® -->
    <script src="supabase-config.js"></script>
</head>
<body>
    <!-- æ•°æ®åº“è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
    <div id="database-status" style="display: none;"></div>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-paw"></i>
                <span>PawPals</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> é¦–é¡µ</a></li>
                <li><a href="pet-profile.html" class="nav-link"><i class="fas fa-id-card"></i> å® ç‰©æ¡£æ¡ˆ</a></li>
                <li><a href="community.html" class="nav-link active"><i class="fas fa-users"></i> åŒåŸåŠ¨æ€</a></li>
                <li><a href="auth.html" class="nav-link" id="authLink"><i class="fas fa-user"></i> ç™»å½•/æ³¨å†Œ</a></li>
            </ul>
        </div>
    </nav>

    <!-- åŒåŸåŠ¨æ€ä¸»å†…å®¹ -->
    <main class="community-container">
        <div class="container">


            <!-- åŠ¨æ€åˆ—è¡¨ -->
            <section class="feed-section">
                <div class="feed-header">
                    <h2>åŒåŸåŠ¨æ€</h2>
                    <button class="new-post-btn">
                        <i class="fas fa-edit"></i>
                        å‘å¸ƒåŠ¨æ€
                    </button>
                </div>
                
                <div class="feed-list">
                    <!-- åŠ¨æ€å†…å®¹å°†ä»æ•°æ®åº“åŠ¨æ€åŠ è½½ -->
                </div>
            </section>
        </div>
    </main>

    <!-- å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å‘å¸ƒåŠ¨æ€</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postForm">
                    <div class="form-group">
                        <label for="postContent">åŠ¨æ€å†…å®¹</label>
                        <textarea id="postContent" placeholder="åˆ†äº«ä½ çš„å® ç‰©æ—¥å¸¸..." rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="location">åœ°ç†ä½ç½®</label>
                        <input type="text" id="location" placeholder="é€‰æ‹©æˆ–è¾“å…¥ä½ç½®">
                    </div>
                    <div class="form-group">
                        <label>å® ç‰©æ ‡ç­¾</label>
                        <div class="tags-input">
                            <input type="text" id="tagInput" placeholder="è¾“å…¥æ ‡ç­¾ï¼ŒæŒ‰å›è½¦æ·»åŠ ">
                            <div class="selected-tags"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">å–æ¶ˆ</button>
                <button class="submit-btn">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>å…³äºæˆ‘ä»¬</h3>
                    <p>PawPals è‡´åŠ›äºä¸ºå® ç‰©ä¸»äººæä¾›å…¨æ–¹ä½çš„ç¤¾äº¤å’ŒæœåŠ¡å¹³å°</p>
                </div>
                <div class="footer-section">
                    <h3>è”ç³»æ–¹å¼</h3>
                    <p>é‚®ç®±ï¼šcontact@pawpals.com</p>
                    <p>ç”µè¯ï¼š400-123-4567</p>
                </div>
                <div class="footer-section">
                    <h3>éšç§æ”¿ç­–</h3>
                    <p>æˆ‘ä»¬ä¸¥æ ¼ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œç¡®ä¿ä¿¡æ¯å®‰å…¨</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PawPals. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // å¦‚æœPawPalså¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœ¬åœ°çš„showToastå‡½æ•°
        if (typeof PawPals === 'undefined') {
            window.PawPals = {
                showToast: function(message) {
                    // ç§»é™¤ç°æœ‰çš„æç¤º
                    const existingToast = document.querySelector('.toast');
                    if (existingToast) {
                        existingToast.remove();
                    }
                    
                    // åˆ›å»ºæ–°çš„æç¤º
                    const toast = document.createElement('div');
                    toast.className = 'toast';
                    toast.textContent = message;
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 4px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    `;
                    
                    document.body.appendChild(toast);
                    
                    // 3ç§’åè‡ªåŠ¨ç§»é™¤
                    setTimeout(() => {
                        toast.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 300);
                    }, 3000);
                }
            };
        }
        // å¦‚æœPawPalså¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœ¬åœ°çš„showToastå‡½æ•°
        if (typeof PawPals === 'undefined') {
            window.PawPals = {
                showToast: function(message) {
                    // ç§»é™¤ç°æœ‰çš„æç¤º
                    const existingToast = document.querySelector('.toast');
                    if (existingToast) {
                        existingToast.remove();
                    }
                    
                    // åˆ›å»ºæ–°çš„æç¤º
                    const toast = document.createElement('div');
                    toast.className = 'toast';
                    toast.textContent = message;
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 4px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    `;
                    
                    document.body.appendChild(toast);
                    
                    // 3ç§’åè‡ªåŠ¨ç§»é™¤
                    setTimeout(() => {
                        toast.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 300);
                    }, 3000);
                }
            };
        }
        // æ·»åŠ æ–°åŠ¨æ€åˆ°åˆ—è¡¨
        function addNewPost(content, location, tags) {
            const feedList = document.querySelector('.feed-list');
            const newPost = document.createElement('div');
            newPost.className = 'feed-item';
            newPost.innerHTML = `
                <div class="post-header">
                    <div class="user-info">
                        <div class="avatar">æˆ‘</div>
                        <div class="user-details">
                            <span class="username">æˆ‘</span>
                            <span class="pet-name">æˆ‘çš„å® ç‰©</span>
                        </div>
                    </div>
                    <span class="post-time">åˆšåˆš</span>
                </div>
                
                <div class="post-content">
                    <p>${content}</p>
                    <div class="post-tags">
                        ${tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                    </div>
                </div>
                
                <div class="post-meta">
                    <span><i class="fas fa-map-marker-alt"></i> ${location || 'æœªçŸ¥ä½ç½®'}</span>
                    <span><i class="fas fa-comments"></i> 0æ¡è¯„è®º</span>
                </div>
                
                <div class="post-actions">
                    <!-- å·²ç§»é™¤ç‚¹èµã€è¯„è®ºå’Œåˆ†äº«åŠŸèƒ½ -->
                </div>
            `;
            
            feedList.insertBefore(newPost, feedList.firstChild);
            PawPals.showToast('åŠ¨æ€å·²æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨');
        }

        // æ˜¾ç¤ºåŠ¨æ€è¯¦æƒ…æ¨¡æ€æ¡†
        function showPostDetailModal(postItem) {
            const username = postItem.querySelector('.username').textContent;
            const petName = postItem.querySelector('.pet-name').textContent;
            const content = postItem.querySelector('.post-content p').textContent;
            const location = postItem.querySelector('.post-meta span:first-child').textContent;
            const time = postItem.querySelector('.post-time').textContent;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="user-info">
                            <div class="avatar">${username.charAt(0)}</div>
                            <div>
                                <h3>${username}</h3>
                                <!-- å·²ç§»é™¤å® ç‰©åç§° -->
                            </div>
                        </div>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="line-height: 1.6; margin-bottom: 15px;">${content}</p>
                        <div class="post-meta">
                            <span>${location}</span>
                            <span>${time}</span>
                        </div>
                        <div class="post-tags">
                            ${Array.from(postItem.querySelectorAll('.tag')).map(tag => tag.outerHTML).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="close-btn">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // å…³é—­åŠŸèƒ½
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // ä¿å­˜åŠ¨æ€åˆ°æ•°æ®åº“
        async function savePostToDatabase(content, location, tags) {
            try {
                console.log('å¼€å§‹ä¿å­˜åŠ¨æ€åˆ°æ•°æ®åº“...');
                
                // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–Supabase
                if (!window.supabaseClient) {
                    console.error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    PawPals.showToast('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }

                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError) {
                    console.error('è·å–ç”¨æˆ·è®¤è¯ä¿¡æ¯å¤±è´¥:', authError);
                    PawPals.showToast('è¯·å…ˆç™»å½•åå†å‘å¸ƒåŠ¨æ€');
                    return false;
                }
                
                if (!user) {
                    console.error('ç”¨æˆ·æœªç™»å½•');
                    PawPals.showToast('è¯·å…ˆç™»å½•åå†å‘å¸ƒåŠ¨æ€');
                    return false;
                }

                console.log('å½“å‰ç”¨æˆ·:', user);

                // åˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                let userId = null;
                try {
                    // é¦–å…ˆå°è¯•æŸ¥æ‰¾ç”¨æˆ·
                    const { data: userData, error: userError } = await supabaseClient
                        .from('users')
                        .select('id')
                        .eq('auth_id', user.id)
                        .single();

                    if (userError) {
                        console.log('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»ºæ–°ç”¨æˆ·è®°å½•');
                        // åˆ›å»ºæ–°ç”¨æˆ·è®°å½•
                        const { data: newUser, error: createError } = await supabaseClient
                            .from('users')
                            .insert({
                                auth_id: user.id,
                                username: user.email?.split('@')[0] || 'æ–°ç”¨æˆ·',
                                email: user.email,
                                display_name: user.email?.split('@')[0] || 'æ–°ç”¨æˆ·',
                                avatar_color: '#4CAF50',
                                is_active: true,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                            .select('id')
                            .single();

                        if (createError) {
                            console.error('åˆ›å»ºç”¨æˆ·è®°å½•å¤±è´¥:', createError);
                            console.log('å°†ç›´æ¥ä½¿ç”¨auth_idä½œä¸ºç”¨æˆ·ID');
                            userId = user.id; // ä½¿ç”¨auth_idä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                        } else {
                            userId = newUser.id;
                            console.log('ç”¨æˆ·è®°å½•åˆ›å»ºæˆåŠŸï¼Œç”¨æˆ·ID:', userId);
                        }
                    } else {
                        userId = userData.id;
                        console.log('æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œç”¨æˆ·ID:', userId);
                    }
                } catch (error) {
                    console.error('å¤„ç†ç”¨æˆ·ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    userId = user.id; // ä½¿ç”¨auth_idä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                }

                if (!userId) {
                    console.error('æ— æ³•è·å–ç”¨æˆ·ID');
                    PawPals.showToast('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥');
                    return false;
                }

                // å·²ç§»é™¤å® ç‰©å…³è”åŠŸèƒ½

                // æ„å»ºåŠ¨æ€æ•°æ®
                const postData = {
                    user_id: userId,
                    content: content,
                    location: location || 'æœªçŸ¥ä½ç½®',
                    tags: tags.join(',') || '',
                    is_public: true,
                    like_count: 0,
                    comment_count: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                console.log('å‡†å¤‡ä¿å­˜çš„åŠ¨æ€æ•°æ®:', postData);

                // ä¿å­˜åˆ°æ•°æ®åº“
                const { data, error } = await supabaseClient
                    .from('posts')
                    .insert([postData])
                    .select();

                if (error) {
                    console.error('ä¿å­˜åŠ¨æ€å¤±è´¥:', error);
                    
                    // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    if (error.code === '42P01') {
                        console.error('postsè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ•°æ®åº“è¡¨');
                        PawPals.showToast('æ•°æ®åº“è¡¨æœªåˆ›å»ºï¼Œè¯·å…ˆè¿è¡Œæ•°æ®åº“è„šæœ¬');
                        
                        // æ˜¾ç¤ºåˆ›å»ºè¡¨çš„SQL
                        console.log('è¯·è¿è¡Œä»¥ä¸‹SQLè¯­å¥åˆ›å»ºpostsè¡¨:');
                        console.log(`
CREATE TABLE IF NOT EXISTS posts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    location VARCHAR(100),
    tags JSONB,
    is_public BOOLEAN DEFAULT TRUE,
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
                        `);
                    } else if (error.code === '42501') {
                        console.error('æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥RLSç­–ç•¥');
                        PawPals.showToast('æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    } else {
                        PawPals.showToast('åŠ¨æ€å‘å¸ƒå¤±è´¥: ' + error.message);
                    }
                    
                    return false;
                }

                console.log('åŠ¨æ€ä¿å­˜æˆåŠŸ:', data);
                return true;
            } catch (error) {
                console.error('ä¿å­˜åŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
                PawPals.showToast('å‘å¸ƒåŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸: ' + error.message);
                return false;
            }
        }

        // ç”¨æˆ·ä¸ªäººèµ„æ–™æ¨¡æ€æ¡†
        async function showUserProfileModal(username) {
            // è·å–ç”¨æˆ·ä¿¡æ¯
            let displayName = username;
            let userAvatar = username.charAt(0);
            
            try {
                // å¦‚æœæœ‰æ•°æ®åº“è¿æ¥ï¼Œå°è¯•è·å–å®é™…çš„ç”¨æˆ·ä¿¡æ¯
                if (window.supabaseClient && window.databaseInitialized) {
                    // è·å–ç”¨æˆ·ä¿¡æ¯
                    const result = await SupabaseData.getUserByUsername(username);
                    if (result.success) {
                        displayName = result.data.display_name || result.data.username;
                        userAvatar = displayName.charAt(0);
                    }
                }
            } catch (error) {
                console.warn('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // ä½¿ç”¨ä¼ å…¥çš„ç”¨æˆ·åä½œä¸ºé»˜è®¤å€¼
            }
            
            // ä¼˜å…ˆä½¿ç”¨"æ¨å¤šæ£’"ä½œä¸ºæ˜¾ç¤ºåç§°
            displayName = 'æ¨å¤šæ£’';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="user-info">
                            <div class="avatar" style="width: 60px; height: 60px;">${displayName.charAt(0)}</div>
                            <div>
                                <h3>${displayName}</h3>
                                <span>å® ç‰©çˆ±å¥½è€…</span>
                            </div>
                        </div>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <p>${displayName} æ˜¯ä¸€ä½çƒ­çˆ±å® ç‰©çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„å…»å® ç»éªŒã€‚</p>
                        </div>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <h4>3</h4>
                                <p>å® ç‰©æ•°é‡</p>
                            </div>
                            <div>
                                <h4>28</h4>
                                <p>åŠ¨æ€æ•°é‡</p>
                            </div>
                            <div>
                                <h4>156</h4>
                                <p>è·èµæ•°</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="close-btn">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // ç­‰å¾…æ•°æ®åº“è¿æ¥å®Œæˆçš„å‡½æ•°
        async function waitForDatabaseConnection(maxWaitTime = 8000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                
                const checkConnection = () => {
                    if (window.supabaseClient && window.databaseInitialized === true) {
                        console.log('âœ… æ•°æ®åº“è¿æ¥å·²å°±ç»ªï¼ŒsupabaseClientå¯ç”¨');
                        resolve(true);
                        return;
                    }
                    
                    if (Date.now() - startTime > maxWaitTime) {
                        console.warn('âš ï¸ ç­‰å¾…æ•°æ®åº“è¿æ¥è¶…æ—¶ï¼Œå°†æ˜¾ç¤ºé”™è¯¯çŠ¶æ€');
                        console.log('å½“å‰çŠ¶æ€ - supabaseClient:', window.supabaseClient ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
                        console.log('å½“å‰çŠ¶æ€ - databaseInitialized:', window.databaseInitialized);
                        resolve(false);
                        return;
                    }
                    
                    setTimeout(checkConnection, 200);
                };
                
                checkConnection();
            });
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        async function checkUserLoggedIn() {
            if (!window.supabaseClient) {
                console.warn('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return null;
            }
            
            try {
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
                return null;
            }
        }
        
        // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤ºå·²ç™»å½•ç”¨æˆ·ä¿¡æ¯
        function updateNavbarForLoggedInUser(user) {
            const authLink = document.querySelector('.nav-menu a[href="auth.html"]');
            if (authLink) {
                // è·å–ç”¨æˆ·åï¼ˆä¼˜å…ˆä½¿ç”¨display_nameï¼Œå¦åˆ™ä½¿ç”¨emailå‰ç¼€ï¼‰
                const username = user.user_metadata?.display_name || 
                                user.email?.split('@')[0] || 
                                'ç”¨æˆ·';
                
                authLink.innerHTML = `<i class="fas fa-user"></i> ${username}`;
                authLink.href = '#';
                authLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·èœå•æˆ–ä¸ªäººé¡µé¢é“¾æ¥
                    alert(`æ¬¢è¿ï¼Œ${username}ï¼`);
                });
            }
        }

        // åŒåŸåŠ¨æ€é¡µé¢ç‰¹å®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('å¼€å§‹åˆå§‹åŒ–åŒåŸåŠ¨æ€é¡µé¢...');
            
            // é¦–å…ˆè°ƒç”¨Supabaseåˆå§‹åŒ–
            await initPageSupabase();
            
            // ç­‰å¾…æ•°æ®åº“è¿æ¥å®Œæˆ
            const dbReady = await waitForDatabaseConnection();
            
            if (!dbReady) {
                console.log('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º');
                showDatabaseError();
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            const user = await checkUserLoggedIn();
            if (user) {
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                updateNavbarForLoggedInUser(user);
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸ');
            }
            
            // ä»æ•°æ®åº“åŠ è½½åŠ¨æ€
            await loadPostsFromDatabase();
            
            // åˆå§‹åŒ–é¡µé¢äº‹ä»¶
            initPostEvents();
            
            console.log('åŒåŸåŠ¨æ€é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // ä»æ•°æ®åº“åŠ è½½åŠ¨æ€
        async function loadPostsFromDatabase() {
            try {
                console.log('å¼€å§‹ä»æ•°æ®åº“åŠ è½½åŠ¨æ€...');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const feedList = document.querySelector('.feed-list');
                feedList.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">æ­£åœ¨åŠ è½½åŠ¨æ€...</p>
                    </div>
                `;
                
                // è·å–åŠ¨æ€æ•°æ®
                const result = await SupabaseData.getPosts();
                
                if (result.success && result.data) {
                    console.log('è·å–åˆ°åŠ¨æ€æ•°æ®:', result.data);
                    renderPosts(result.data);
                } else {
                    console.error('è·å–åŠ¨æ€æ•°æ®å¤±è´¥:', result.error);
                    showLoadError('åŠ è½½åŠ¨æ€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½åŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
                showLoadError('åŠ è½½åŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸: ' + error.message);
            }
        }

        // æ¸²æŸ“åŠ¨æ€åˆ—è¡¨
        function renderPosts(posts) {
            const feedList = document.querySelector('.feed-list');
            
            if (!posts || posts.length === 0) {
                feedList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>æš‚æ— åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            posts.forEach(post => {
                // å¤„ç†æ—¶é—´æ˜¾ç¤º
                const postTime = formatPostTime(post.created_at);
                
                // å¤„ç†æ ‡ç­¾
                let tagsHtml = '';
                if (post.tags) {
                    // å¦‚æœtagsæ˜¯JSONBæ ¼å¼
                    if (typeof post.tags === 'object') {
                        tagsHtml = Object.values(post.tags).map(tag => 
                            `<span class="tag">#${tag}</span>`
                        ).join('');
                    } 
                    // å¦‚æœtagsæ˜¯é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
                    else if (typeof post.tags === 'string') {
                        tagsHtml = post.tags.split(',').map(tag => 
                            `<span class="tag">#${tag.trim()}</span>`
                        ).join('');
                    }
                }
                
                // ç”¨æˆ·ä¿¡æ¯
                const username = post.users?.username || 'åŒ¿åç”¨æˆ·';
                const displayName = post.users?.display_name || username;
                const userAvatar = displayName.charAt(0);
                
                // å·²ç§»é™¤å® ç‰©ä¿¡æ¯
                
                html += `
                    <div class="feed-item">
                        <div class="post-header">
                            <div class="user-info">
                                <div class="avatar">${userAvatar}</div>
                                <div class="user-details">
                                    <span class="username">${displayName}</span>
                                    <!-- å·²ç§»é™¤å® ç‰©åç§° -->
                                </div>
                            </div>
                            <span class="post-time">${postTime}</span>
                        </div>
                        
                        <div class="post-content">
                            <p>${post.content}</p>
                            ${tagsHtml ? `<div class="post-tags">${tagsHtml}</div>` : ''}
                        </div>
                        
                        <div class="post-meta">
                            <span><i class="fas fa-map-marker-alt"></i> ${post.location || 'æœªçŸ¥ä½ç½®'}</span>
                            <span><i class="fas fa-comments"></i> ${post.comment_count || 0}æ¡è¯„è®º</span>
                        </div>
                        
                        <!-- å·²ç§»é™¤ç‚¹èµã€è¯„è®ºå’Œåˆ†äº«åŠŸèƒ½ -->
                    </div>
                `;
            });
            
            feedList.innerHTML = html;
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindPostEvents();
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatPostTime(created_at) {
            if (!created_at) return 'æœªçŸ¥æ—¶é—´';
            
            const postDate = new Date(created_at);
            const now = new Date();
            const diff = now - postDate;
            
            // è®¡ç®—æ—¶é—´å·®
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) {
                return 'åˆšåˆš';
            } else if (minutes < 60) {
                return `${minutes}åˆ†é’Ÿå‰`;
            } else if (hours < 24) {
                return `${hours}å°æ—¶å‰`;
            } else if (days < 30) {
                return `${days}å¤©å‰`;
            } else {
                return postDate.toLocaleDateString('zh-CN');
            }
        }

        // æ˜¾ç¤ºåŠ è½½é”™è¯¯
        function showLoadError(message) {
            const feedList = document.querySelector('.feed-list');
            feedList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #f44336;">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>${message}</p>
                    <button class="action-btn" onclick="loadPostsFromDatabase()" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i>
                        é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯
        function showDatabaseError() {
            const feedList = document.querySelector('.feed-list');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯éƒ¨ç½²ç¯å¢ƒ
            const isDeployed = typeof window !== 'undefined' && 
                             window.location.hostname !== 'localhost' && 
                             window.location.hostname !== '127.0.0.1' &&
                             !window.location.hostname.startsWith('192.168.');
            
            let additionalInfo = '';
            if (isDeployed) {
                additionalInfo = `
                    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeaa7;">
                        <h4 style="margin-top: 0; color: #856404;">ğŸ’¡ éƒ¨ç½²ç¯å¢ƒè§£å†³æ–¹æ¡ˆ</h4>
                        <p style="margin-bottom: 0.5rem;">è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š</p>
                        <ol style="text-align: left; margin-left: 1.5rem;">
                            <li>ç™»å½•Supabaseä»ªè¡¨æ¿</li>
                            <li>è¿›å…¥Project Settings > API</li>
                            <li>åœ¨"Allowed URLs"éƒ¨åˆ†æ·»åŠ å½“å‰éƒ¨ç½²URL: <strong>${window.location.origin}</strong></li>
                            <li>ä¿å­˜æ›´æ”¹å¹¶é‡æ–°éƒ¨ç½²åº”ç”¨</li>
                        </ol>
                    </div>
                `;
            }
            
            feedList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #f44336;">
                    <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>æ•°æ®åº“è¿æ¥å¤±è´¥</h3>
                    <p>æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                        <p>å¯èƒ½çš„åŸå› ï¼š</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                            <li>SupabaseæœåŠ¡æš‚æ—¶ä¸å¯ç”¨</li>
                            <li>${isDeployed ? 'éƒ¨ç½²ç¯å¢ƒçš„CORSé™åˆ¶' : 'CORSé™åˆ¶'}</li>
                            <li>APIå¯†é’¥é…ç½®é—®é¢˜</li>
                        </ul>
                    </div>
                    ${additionalInfo}
                    <button class="action-btn" onclick="location.reload()" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i>
                        é‡æ–°åŠ è½½é¡µé¢
                    </button>
                    <button class="action-btn" onclick="showConnectionDiagnostics()" style="margin-top: 1rem; margin-left: 10px; background: #ff9800;">
                        <i class="fas fa-bug"></i>
                        è¯Šæ–­è¿æ¥é—®é¢˜
                    </button>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºè¿æ¥è¯Šæ–­ä¿¡æ¯
        function showConnectionDiagnostics() {
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
            console.log('=== æ•°æ®åº“è¿æ¥è¯Šæ–­ ===');
            console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
            console.log('Supabaseå®¢æˆ·ç«¯çŠ¶æ€:', window.supabaseClient ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
            console.log('æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€:', window.databaseInitialized);
            
            if (window.supabaseClient) {
                console.log('Supabase URL:', window.supabaseClient.supabaseUrl);
            }
            
            // æ˜¾ç¤ºé¡µé¢URLä¿¡æ¯
            if (typeof window !== 'undefined' && window.location) {
                console.log('å½“å‰é¡µé¢URL:', window.location.href);
                console.log('é¡µé¢åè®®:', window.location.protocol);
                console.log('é¡µé¢åŸŸå:', window.location.hostname);
            }
            
            // æç¤ºç”¨æˆ·æŸ¥çœ‹æ§åˆ¶å°
            if (typeof alert !== 'undefined') {
                alert('è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸­çš„è¯¦ç»†è¯Šæ–­ä¿¡æ¯ã€‚');
            }
        }

        // é‡æ–°ç»‘å®šåŠ¨æ€é¡¹äº‹ä»¶
        function bindPostEvents() {
            // å·²ç§»é™¤ç‚¹èµã€è¯„è®ºå’Œåˆ†äº«æŒ‰é’®å¼•ç”¨
            const feedItems = document.querySelectorAll('.feed-item');
            
            // å·²ç§»é™¤ç‚¹èµã€è¯„è®ºå’Œåˆ†äº«åŠŸèƒ½
            
            // åŠ¨æ€é¡¹ç‚¹å‡»åŠŸèƒ½
            feedItems.forEach(item => {
                // ç‚¹å‡»åŠ¨æ€å†…å®¹æŸ¥çœ‹è¯¦æƒ…
                const content = item.querySelector('.post-content');
                content.addEventListener('click', function(e) {
                    if (!e.target.closest('.tag') && !e.target.closest('.post-actions')) {
                        const username = item.querySelector('.username').textContent;
                        PawPals.showToast(`æŸ¥çœ‹ ${username} çš„åŠ¨æ€è¯¦æƒ…`);
                        showPostDetailModal(item);
                    }
                });
                
                // ç”¨æˆ·å¤´åƒå’Œåç§°ç‚¹å‡»æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
                const userInfo = item.querySelector('.user-info');
                userInfo.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const username = item.querySelector('.username').textContent;
                    PawPals.showToast(`æŸ¥çœ‹ ${username} çš„ä¸ªäººä¸»é¡µ`);
                    await showUserProfileModal(username);
                });
            });
        }

        // åˆå§‹åŒ–é¡µé¢äº‹ä»¶
        function initPostEvents() {
            const newPostBtn = document.querySelector('.new-post-btn');
            const modal = document.getElementById('postModal');
            const closeBtn = document.querySelector('.close-btn');
            const cancelBtn = document.querySelector('.cancel-btn');
            const submitBtn = document.querySelector('.submit-btn');
            const tagInput = document.getElementById('tagInput');
            let selectedTags = [];
            
            // æ ‡ç­¾è¾“å…¥åŠŸèƒ½
            function updateSelectedTags() {
                const container = document.querySelector('.selected-tags');
                container.innerHTML = selectedTags.map(tag => 
                    `<span class="tag">${tag}<i class="fas fa-times" onclick="removeTag('${tag}')"></i></span>`
                ).join('');
            }
            
            window.removeTag = function(tag) {
                selectedTags = selectedTags.filter(t => t !== tag);
                updateSelectedTags();
            };
            
            // æ ‡ç­¾è¾“å…¥åŠŸèƒ½
            if (tagInput) {
                tagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const tag = this.value.trim();
                        if (tag && selectedTags.length < 5) {
                            selectedTags.push(tag);
                            this.value = '';
                            updateSelectedTags();
                        }
                    }
                });
            }

            // å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ§åˆ¶
            newPostBtn.addEventListener('click', function() {
                modal.style.display = 'block';
            });

            function closeModal() {
                modal.style.display = 'none';
                document.getElementById('postForm').reset();
                selectedTags = [];
                updateSelectedTags();
            }

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });

            // å‘å¸ƒåŠ¨æ€
            submitBtn.addEventListener('click', async function() {
                const content = document.getElementById('postContent').value;
                const location = document.getElementById('location').value;
                if (!content.trim()) {
                    PawPals.showToast('è¯·è¾“å…¥åŠ¨æ€å†…å®¹');
                    return;
                }
                
                // æ·»åŠ åŠ è½½çŠ¶æ€
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'å‘å¸ƒä¸­...';
                
                try {
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    const success = await savePostToDatabase(content, location, selectedTags);
                    
                    if (success) {
                        PawPals.showToast('åŠ¨æ€å‘å¸ƒæˆåŠŸï¼');
                        // é‡æ–°åŠ è½½åŠ¨æ€åˆ—è¡¨
                        await loadPostsFromDatabase();
                        closeModal();
                    } else {
                        // é”™è¯¯ä¿¡æ¯å·²ç»åœ¨savePostToDatabaseä¸­æ˜¾ç¤ºï¼Œè¿™é‡Œä¸å†é‡å¤æ˜¾ç¤º
                        console.log('åŠ¨æ€å‘å¸ƒå¤±è´¥ï¼Œä½†æ²¡æœ‰æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯');
                    }
                } catch (error) {
                    console.error('å‘å¸ƒåŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
                    PawPals.showToast('å‘å¸ƒåŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸: ' + error.message);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }

    </script>
</body>
</html>