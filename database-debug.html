<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è¿æ¥è¯Šæ–­ - PawPals</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status.pending {
            background: #ffc107;
            color: #212529;
        }
        
        .status.success {
            background: #28a745;
            color: white;
        }
        
        .status.error {
            background: #dc3545;
            color: white;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .solution {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 5px 5px 0;
        }
        
        .solution h4 {
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #2980b9;
        }
        
        .button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ•°æ®åº“è¿æ¥è¯Šæ–­</h1>
            <p>PawPals æ•°æ®åº“è¿æ¥é—®é¢˜è¯Šæ–­å·¥å…·</p>
        </div>
        
        <div class="content">
            <div class="test-section">
                <h3>
                    <span>1. ç½‘ç»œè¿æ¥æµ‹è¯•</span>
                    <span id="networkStatus" class="status pending">ç­‰å¾…æµ‹è¯•</span>
                </h3>
                <p>æµ‹è¯•ä¸SupabaseæœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥...</p>
                <div id="networkLog" class="log"></div>
                <div id="networkSolution" class="solution" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>
                    <span>2. APIå¯†é’¥éªŒè¯</span>
                    <span id="apiStatus" class="status pending">ç­‰å¾…æµ‹è¯•</span>
                </h3>
                <p>éªŒè¯Supabase APIå¯†é’¥æ˜¯å¦æ­£ç¡®...</p>
                <div id="apiLog" class="log"></div>
                <div id="apiSolution" class="solution" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>
                    <span>3. æ•°æ®åº“è¡¨æ£€æŸ¥</span>
                    <span id="tableStatus" class="status pending">ç­‰å¾…æµ‹è¯•</span>
                </h3>
                <p>æ£€æŸ¥å¿…è¦çš„æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨...</p>
                <div id="tableLog" class="log"></div>
                <div id="tableSolution" class="solution" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>
                    <span>4. RLSç­–ç•¥æ£€æŸ¥</span>
                    <span id="rlsStatus" class="status pending">ç­‰å¾…æµ‹è¯•</span>
                </h3>
                <p>æ£€æŸ¥è¡Œçº§å®‰å…¨ç­–ç•¥è®¾ç½®...</p>
                <div id="rlsLog" class="log"></div>
                <div id="rlsSolution" class="solution" style="display: none;"></div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button id="runTests" class="button">ğŸš€ å¼€å§‹è¯Šæ–­</button>
                <button id="fixAll" class="button" style="background: #27ae60; display: none; margin-left: 15px;">ğŸ”§ è‡ªåŠ¨ä¿®å¤</button>
            </div>
            
            <div class="summary">
                <h3>è¯Šæ–­æ‘˜è¦</h3>
                <div id="summaryContent">
                    <div class="summary-item">
                        <span>æ€»æµ‹è¯•é¡¹ï¼š</span>
                        <span id="totalTests">4</span>
                    </div>
                    <div class="summary-item">
                        <span>é€šè¿‡ï¼š</span>
                        <span id="passedTests">0</span>
                    </div>
                    <div class="summary-item">
                        <span>å¤±è´¥ï¼š</span>
                        <span id="failedTests">0</span>
                    </div>
                    <div class="summary-item">
                        <span>æ€»ä½“çŠ¶æ€ï¼š</span>
                        <span id="overallStatus" style="font-weight: bold;">æœªå¼€å§‹</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://aiigtntikyxqqqsmqidj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpaWd0bnRpa3l4cXFxc21xaWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0OTkyMTUsImV4cCI6MjA3ODA3NTIxNX0.MSwn6jJw-6WHplhEfe2JejM6aAVH_lmdnqhVWkkWLMQ';
        
        let supabaseClient = null;
        let testResults = {
            network: { status: 'pending', message: '' },
            api: { status: 'pending', message: '' },
            tables: { status: 'pending', message: '' },
            rls: { status: 'pending', message: '' }
        };
        
        // æ›´æ–°æµ‹è¯•çŠ¶æ€
        function updateTestStatus(testName, status, message = '') {
            testResults[testName].status = status;
            testResults[testName].message = message;
            
            // æ›´æ–°UI
            const statusElement = document.getElementById(testName + 'Status');
            const logElement = document.getElementById(testName + 'Log');
            const solutionElement = document.getElementById(testName + 'Solution');
            
            statusElement.textContent = {
                pending: 'ç­‰å¾…æµ‹è¯•',
                success: 'âœ“ é€šè¿‡',
                error: 'âœ— å¤±è´¥'
            }[status];
            
            statusElement.className = 'status ' + status;
            
            if (message) {
                logElement.innerHTML = message;
            }
            
            if (status === 'error') {
                solutionElement.style.display = 'block';
                solutionElement.innerHTML = getSolution(testName);
            }
            
            updateSummary();
        }
        
        // è·å–è§£å†³æ–¹æ¡ˆ
        function getSolution(testName) {
            const solutions = {
                network: `
                    <h4>ç½‘ç»œè¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ</h4>
                    <p><strong>é—®é¢˜è¯Šæ–­ï¼š</strong>æ— æ³•è¿æ¥åˆ°SupabaseæœåŠ¡å™¨</p>
                    <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <ol>
                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                        <li>æ£€æŸ¥é˜²ç«å¢™è®¾ç½®</li>
                        <li>å°è¯•ä½¿ç”¨å…¶ä»–ç½‘ç»œç¯å¢ƒ</li>
                        <li>ç¡®è®¤SupabaseæœåŠ¡çŠ¶æ€</li>
                    </ol>
                `,
                api: `
                    <h4>APIå¯†é’¥é—®é¢˜è§£å†³æ–¹æ¡ˆ</h4>
                    <p><strong>é—®é¢˜è¯Šæ–­ï¼š</strong>APIå¯†é’¥éªŒè¯å¤±è´¥</p>
                    <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <ol>
                        <li>æ£€æŸ¥Supabase URLæ˜¯å¦æ­£ç¡®</li>
                        <li>æ£€æŸ¥APIå¯†é’¥æ˜¯å¦è¿‡æœŸ</li>
                        <li>åœ¨Supabaseä»ªè¡¨æ¿ä¸­é‡æ–°ç”Ÿæˆå¯†é’¥</li>
                        <li>ç¡®è®¤é¡¹ç›®è®¾ç½®ä¸­çš„APIæƒé™</li>
                    </ol>
                `,
                tables: `
                    <h4>æ•°æ®åº“è¡¨é—®é¢˜è§£å†³æ–¹æ¡ˆ</h4>
                    <p><strong>é—®é¢˜è¯Šæ–­ï¼š</strong>å¿…è¦çš„æ•°æ®åº“è¡¨ä¸å­˜åœ¨</p>
                    <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <p>åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹SQLï¼š</p>
                    <pre style="background: #2c3e50; color: white; padding: 10px; border-radius: 5px; overflow-x: auto;">
-- åˆ›å»ºåŸºç¡€è¡¨ç»“æ„
CREATE TABLE IF NOT EXISTS users (
    id BIGSERIAL PRIMARY KEY,
    auth_id UUID UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(50),
    avatar_color CHAR(7) DEFAULT '#4CAF50',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS posts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    pet_id BIGINT,
    content TEXT NOT NULL,
    location VARCHAR(100),
    tags TEXT,
    is_public BOOLEAN DEFAULT TRUE,
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
                    </pre>
                `,
                rls: `
                    <h4>RLSç­–ç•¥é—®é¢˜è§£å†³æ–¹æ¡ˆ</h4>
                    <p><strong>é—®é¢˜è¯Šæ–­ï¼š</strong>è¡Œçº§å®‰å…¨ç­–ç•¥é™åˆ¶è®¿é—®</p>
                    <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <p>åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹SQLï¼š</p>
                    <pre style="background: #2c3e50; color: white; padding: 10px; border-radius: 5px; overflow-x: auto;">
-- å¯ç”¨RLSå¹¶è®¾ç½®ç­–ç•¥
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

-- å…è®¸ä»»ä½•äººè¯»å–å…¬å¼€æ•°æ®
CREATE POLICY "å…è®¸ä»»ä½•äººè¯»å–ç”¨æˆ·æ•°æ®" ON users
    FOR SELECT USING (true);

CREATE POLICY "å…è®¸ä»»ä½•äººè¯»å–å…¬å¼€åŠ¨æ€" ON posts
    FOR SELECT USING (is_public = true);

-- å…è®¸å·²è®¤è¯ç”¨æˆ·æ’å…¥æ•°æ®
CREATE POLICY "å…è®¸è®¤è¯ç”¨æˆ·æ’å…¥æ•°æ®" ON users
    FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "å…è®¸è®¤è¯ç”¨æˆ·å‘å¸ƒåŠ¨æ€" ON posts
    FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);
                    </pre>
                `
            };
            
            return solutions[testName] || '<p>æœªçŸ¥é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ</p>';
        }
        
        // æ›´æ–°æ‘˜è¦
        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.status === 'success').length;
            const failed = Object.values(testResults).filter(r => r.status === 'error').length;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            
            const overallStatus = document.getElementById('overallStatus');
            if (failed > 0) {
                overallStatus.textContent = 'âŒ å­˜åœ¨è¿æ¥é—®é¢˜';
                overallStatus.style.color = '#dc3545';
                document.getElementById('fixAll').style.display = 'inline-block';
            } else if (passed === total) {
                overallStatus.textContent = 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡';
                overallStatus.style.color = '#28a745';
            } else {
                overallStatus.textContent = 'â³ æµ‹è¯•è¿›è¡Œä¸­';
                overallStatus.style.color = '#ffc107';
            }
        }
        
        // æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testNetwork() {
            updateTestStatus('network', 'pending', 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...');
            
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (response.ok) {
                    updateTestStatus('network', 'success', 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸\nçŠ¶æ€ç : ' + response.status);
                    return true;
                } else {
                    updateTestStatus('network', 'error', 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥\nçŠ¶æ€ç : ' + response.status);
                    return false;
                }
            } catch (error) {
                updateTestStatus('network', 'error', 'âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸: ' + error.message);
                return false;
            }
        }
        
        // æµ‹è¯•APIå¯†é’¥
        async function testAPI() {
            updateTestStatus('api', 'pending', 'æ­£åœ¨éªŒè¯APIå¯†é’¥...');
            
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // æµ‹è¯•è®¤è¯è¿æ¥
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (!error) {
                    updateTestStatus('api', 'success', 'âœ… APIå¯†é’¥éªŒè¯æˆåŠŸ');
                    return true;
                } else {
                    updateTestStatus('api', 'error', 'âŒ APIå¯†é’¥éªŒè¯å¤±è´¥: ' + error.message);
                    return false;
                }
            } catch (error) {
                updateTestStatus('api', 'error', 'âŒ APIå¯†é’¥éªŒè¯å¼‚å¸¸: ' + error.message);
                return false;
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“è¡¨
        async function testTables() {
            updateTestStatus('tables', 'pending', 'æ­£åœ¨æ£€æŸ¥æ•°æ®åº“è¡¨...');
            
            try {
                // æµ‹è¯•usersè¡¨
                const { data: users, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .limit(1);
                
                if (usersError && usersError.code === 'PGRST116') {
                    updateTestStatus('tables', 'error', 'âŒ usersè¡¨ä¸å­˜åœ¨');
                    return false;
                }
                
                // æµ‹è¯•postsè¡¨
                const { data: posts, error: postsError } = await supabaseClient
                    .from('posts')
                    .select('id')
                    .limit(1);
                
                if (postsError && postsError.code === 'PGRST116') {
                    updateTestStatus('tables', 'error', 'âŒ postsè¡¨ä¸å­˜åœ¨');
                    return false;
                }
                
                updateTestStatus('tables', 'success', 'âœ… æ‰€æœ‰å¿…è¦çš„æ•°æ®åº“è¡¨éƒ½å­˜åœ¨');
                return true;
            } catch (error) {
                updateTestStatus('tables', 'error', 'âŒ æ•°æ®åº“è¡¨æ£€æŸ¥å¼‚å¸¸: ' + error.message);
                return false;
            }
        }
        
        // æµ‹è¯•RLSç­–ç•¥
        async function testRLS() {
            updateTestStatus('rls', 'pending', 'æ­£åœ¨æ£€æŸ¥RLSç­–ç•¥...');
            
            try {
                // å°è¯•æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆåº”è¯¥ä¼šè¢«RLSé˜»æ­¢ï¼‰
                const { error } = await supabaseClient
                    .from('users')
                    .insert({
                        username: 'test_user_' + Date.now(),
                        email: 'test@example.com',
                        display_name: 'æµ‹è¯•ç”¨æˆ·'
                    });
                
                // å¦‚æœå‡ºç°æƒé™é”™è¯¯ï¼Œè¯´æ˜RLSå·²å¯ç”¨ä½†ç­–ç•¥å¯èƒ½éœ€è¦è°ƒæ•´
                if (error && error.code === '42501') {
                    updateTestStatus('rls', 'success', 'âœ… RLSç­–ç•¥å·²å¯ç”¨ï¼ˆæƒé™é”™è¯¯æ˜¯é¢„æœŸçš„ï¼‰');
                    return true;
                } else if (error) {
                    updateTestStatus('rls', 'error', 'âŒ RLSç­–ç•¥æ£€æŸ¥å¤±è´¥: ' + error.message);
                    return false;
                } else {
                    updateTestStatus('rls', 'error', 'âŒ RLSå¯èƒ½æœªæ­£ç¡®é…ç½®ï¼ˆå…è®¸äº†åŒ¿åæ’å…¥ï¼‰');
                    return false;
                }
            } catch (error) {
                updateTestStatus('rls', 'error', 'âŒ RLSç­–ç•¥æ£€æŸ¥å¼‚å¸¸: ' + error.message);
                return false;
            }
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const runTestsBtn = document.getElementById('runTests');
            runTestsBtn.disabled = true;
            runTestsBtn.textContent = 'æµ‹è¯•ä¸­...';
            
            // é‡ç½®æ‰€æœ‰æµ‹è¯•çŠ¶æ€
            Object.keys(testResults).forEach(test => {
                updateTestStatus(test, 'pending', '');
            });
            
            // æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•
            const networkOk = await testNetwork();
            if (!networkOk) {
                runTestsBtn.disabled = false;
                runTestsBtn.textContent = 'é‡æ–°æµ‹è¯•';
                return;
            }
            
            const apiOk = await testAPI();
            if (!apiOk) {
                runTestsBtn.disabled = false;
                runTestsBtn.textContent = 'é‡æ–°æµ‹è¯•';
                return;
            }
            
            const tablesOk = await testTables();
            if (!tablesOk) {
                runTestsBtn.disabled = false;
                runTestsBtn.textContent = 'é‡æ–°æµ‹è¯•';
                return;
            }
            
            await testRLS();
            
            runTestsBtn.disabled = false;
            runTestsBtn.textContent = 'é‡æ–°æµ‹è¯•';
        }
        
        // è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
        function autoFix() {
            alert('è‡ªåŠ¨ä¿®å¤åŠŸèƒ½éœ€è¦æ‰‹åŠ¨åœ¨Supabaseä»ªè¡¨æ¿ä¸­æ‰§è¡ŒSQLè¯­å¥ã€‚è¯·æŸ¥çœ‹æ¯ä¸ªæµ‹è¯•é¡¹çš„è§£å†³æ–¹æ¡ˆéƒ¨åˆ†ï¼Œå¤åˆ¶ç›¸åº”çš„SQLä»£ç åˆ°Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œã€‚');
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('runTests').addEventListener('click', runAllTests);
        document.getElementById('fixAll').addEventListener('click', autoFix);
        
        // åˆå§‹åŒ–
        updateSummary();
    </script>
</body>
</html>