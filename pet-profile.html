<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宠物档案 - PawPals</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-paw"></i>
                <span>PawPals</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> 首页</a></li>
                <li><a href="pet-profile.html" class="nav-link active"><i class="fas fa-id-card"></i> 宠物档案</a></li>
                <li><a href="community.html" class="nav-link"><i class="fas fa-users"></i> 同城动态</a></li>
                <li><a href="auth.html" class="nav-link" id="authLink"><i class="fas fa-user"></i> 登录/注册</a></li>
            </ul>
        </div>
    </nav>

    <!-- 宠物档案主内容 -->
    <main class="pet-profile-container">
        <div class="container">
            <!-- 个人宠物列表 -->
            <section class="pet-list-section">
                <div class="section-header">
                    <h2>我的宠物</h2>
                    <button class="add-pet-btn">
                        <i class="fas fa-plus"></i>
                        添加新宠物
                    </button>
                </div>
                
                <div class="pet-cards-grid">
                    <!-- 宠物列表将从数据库动态加载 -->
                    <div id="loading-pets" class="loading-container">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在加载宠物列表...</p>
                    </div>
                </div>
            </section>

            <!-- 宠物详情模块 -->
            <section class="pet-detail-section">
                <div class="pet-detail-card" id="pet-detail-container">
                    <!-- 宠物详情将从数据库动态加载 -->
                    <div id="pet-detail-loading" class="loading-container">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在加载宠物详情...</p>
                    </div>
                </div>

                <!-- 成长时间线 -->
                <div class="timeline-section">
                    <h3><i class="fas fa-history"></i> 成长记录</h3>
                    <div class="timeline" id="timeline-container">
                        <!-- 时间线将从数据库动态加载 -->
                        <div id="timeline-loading" class="loading-container">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>正在加载成长记录...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>关于我们</h3>
                    <p>PawPals 致力于为宠物主人提供全方位的社交和服务平台</p>
                </div>
                <div class="footer-section">
                    <h3>联系方式</h3>
                    <p>邮箱：contact@pawpals.com</p>
                    <p>电话：400-123-4567</p>
                </div>
                <div class="footer-section">
                    <h3>隐私政策</h3>
                    <p>我们严格保护用户隐私，确保信息安全</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PawPals. 保留所有权利。</p>
            </div>
        </div>
    </footer>

    <!-- 引入Supabase SDK - 使用与注册页面相同的CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script>
        // 等待数据库连接完成的函数
        async function waitForDatabaseConnection(maxWaitTime = 8000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                
                const checkConnection = () => {
                    if (window.supabaseClient && window.databaseInitialized === true) {
                        console.log('✅ 数据库连接已就绪，supabaseClient可用');
                        resolve(true);
                        return;
                    }
                    
                    if (Date.now() - startTime > maxWaitTime) {
                        console.warn('⚠️ 等待数据库连接超时，将显示错误状态');
                        console.log('当前状态 - supabaseClient:', window.supabaseClient ? '已定义' : '未定义');
                        console.log('当前状态 - databaseInitialized:', window.databaseInitialized);
                        resolve(false);
                        return;
                    }
                    
                    setTimeout(checkConnection, 200);
                };
                
                checkConnection();
            });
        }
        
        // 检查用户是否已登录
        async function checkUserLoggedIn() {
            if (!window.supabaseClient) {
                console.warn('Supabase客户端未初始化');
                return null;
            }
            
            try {
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) {
                    console.error('获取用户信息失败:', error);
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('检查用户登录状态时发生异常:', error);
                return null;
            }
        }
        
        // 更新导航栏显示已登录用户信息
        function updateNavbarForLoggedInUser(user) {
            const authLink = document.querySelector('.nav-menu a[href="auth.html"]');
            if (authLink) {
                // 获取用户名（优先使用display_name，否则使用email前缀）
                const username = user.user_metadata?.display_name || 
                                user.email?.split('@')[0] || 
                                '用户';
                
                authLink.innerHTML = `<i class="fas fa-user"></i> ${username}`;
                authLink.href = '#';
                authLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 可以在这里添加用户菜单或个人页面链接
                    alert(`欢迎，${username}！`);
                });
            }
        }
        
        // 宠物档案页面特定功能
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('初始化宠物档案页面...');
            
            // 立即显示加载状态
            showLoadingState();
            
            // 首先调用Supabase初始化
            await initPageSupabase();
            
            // 等待数据库连接完成
            const dbReady = await waitForDatabaseConnection();
            
            if (!dbReady) {
                console.log('数据库连接失败，显示错误提示');
                showDatabaseError();
                return;
            }
            
            // 初始化页面事件（但宠物卡片事件将在宠物列表渲染后单独绑定）
            initPetProfileEvents();
            
            // 检查用户是否已登录
            const user = await checkUserLoggedIn();
            if (user) {
                console.log('用户已登录，加载宠物列表');
                // 更新导航栏显示用户信息
                updateNavbarForLoggedInUser(user);
                // 如果用户已登录，加载用户宠物列表
                await loadPetList(user.id);
            } else {
                console.log('用户未登录，显示登录提示');
                // 用户未登录，显示提示信息
                showLoginPrompt();
                // 显示空的宠物详情
                renderPetDetail(null);
                document.getElementById('timeline-container').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>请登录后查看成长记录</p>
                    </div>
                `;
            }
        });
        
        // 初始化宠物档案页面事件 - 仅在页面完全加载后调用
        function initPetProfileEvents() {
            console.log('初始化宠物档案页面事件...');
            
            // 添加宠物按钮功能 - 确保按钮存在
            const addPetBtn = document.querySelector('.add-pet-btn');
            if (addPetBtn) {
                addPetBtn.addEventListener('click', function() {
                    showAddPetModal();
                });
                console.log('添加宠物按钮事件绑定成功');
            } else {
                console.warn('添加宠物按钮未找到，将在动态渲染后重新绑定');
            }
            
            // 时间线项点击功能将在时间线渲染后通过renderTimeline函数绑定
            // 宠物卡片事件将在宠物列表渲染后通过bindPetCardEvents函数单独绑定
        }
        
        // 添加宠物模态框
        function showAddPetModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加新宠物</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addPetForm">
                            <div class="form-group">
                                <label for="petName">宠物名称</label>
                                <input type="text" id="petName" placeholder="请输入宠物名称" required>
                            </div>
                            <div class="form-group">
                                <label for="petType">宠物类型</label>
                                <select id="petType" required>
                                    <option value="">请选择宠物类型</option>
                                    <option value="dog">狗狗</option>
                                    <option value="cat">猫咪</option>
                                    <option value="rabbit">兔子</option>
                                    <option value="bird">鸟类</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="petBreed">品种</label>
                                <input type="text" id="petBreed" placeholder="请输入品种">
                            </div>
                            <div class="form-group">
                                <label for="petBirthday">生日</label>
                                <input type="date" id="petBirthday">
                            </div>
                            <div class="form-group">
                                <label for="petGender">性别</label>
                                <select id="petGender">
                                    <option value="">请选择性别</option>
                                    <option value="male">公</option>
                                    <option value="female">母</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="cancel-btn" type="button">取消</button>
                        <button class="submit-btn" type="button">保存</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 关闭功能
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            const submitBtn = modal.querySelector('.submit-btn');
            
            function closeModal() {
                document.body.removeChild(modal);
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
                    // 提交表单 - 模仿注册页面的成功模式
                    submitBtn.addEventListener('click', async function() {
                        // 获取表单数据
                        const petName = document.getElementById('petName').value;
                        const petType = document.getElementById('petType').value;
                        const petBreed = document.getElementById('petBreed').value;
                        const petBirthday = document.getElementById('petBirthday').value;
                        const petGender = document.getElementById('petGender').value;
                        
                        // 表单验证
                        if (!petName) {
                            alert('请填写宠物名称');
                            return;
                        }
                        
                        if (!petType) {
                            alert('请选择宠物类型');
                            return;
                        }
                        
                        if (!petGender) {
                            alert('请选择宠物性别');
                            return;
                        }
                        
                        // 禁用按钮显示加载状态 - 模仿注册页面
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                        
                        try {
                            // 直接使用全局的supabaseClient，模仿注册页面的调用方式
                            if (!window.supabaseClient) {
                                throw new Error('数据库连接失败，请刷新页面重试');
                            }
                            
                            // 获取当前用户 - 使用与注册页面相同的模式
                            const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
                            
                            if (userError) {
                                // 处理认证会话失效的特殊情况
                                if (userError.message.includes('session missing') || userError.message.includes('Auth session missing')) {
                                    const shouldLogin = confirm('登录会话已失效，是否立即登录？');
                                    if (shouldLogin) {
                                        window.location.href = 'auth.html';
                                    }
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '保存';
                                    return;
                                }
                                throw new Error('用户认证失败: ' + userError.message);
                            }
                            
                            if (!user) {
                                const shouldLogin = confirm('保存宠物需要登录，是否立即登录？');
                                if (shouldLogin) {
                                    window.location.href = 'auth.html';
                                }
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '保存';
                                return;
                            }
                            
                            // 构建宠物数据 - 使用数据库schema中的正确字段
                            const petData = {
                                user_id: user.id,  // 这里应该使用用户的ID，不是UUID
                                name: petName,
                                pet_type: petType,
                                breed: petBreed || '',
                                gender: petGender,
                                birth_date: petBirthday || null,
                                is_public: true,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };
                            
                            console.log('准备保存宠物数据:', petData);
                            
                            // 直接使用Supabase客户端插入数据 - 模仿注册页面的数据插入方式
                            const { data: insertData, error: insertError } = await window.supabaseClient
                                .from('pets')
                                .insert([petData])
                                .select();
                            
                            if (insertError) {
                                console.error('添加宠物失败 - 详细错误:', insertError);
                                
                                // 提供详细的错误信息
                                if (insertError.code === '42501') {
                                    alert('数据库权限不足，请检查RLS策略设置');
                                } else if (insertError.code === '42P01') {
                                    alert('宠物表不存在，请先运行数据库脚本创建表');
                                } else {
                                    alert(`添加宠物失败: ${insertError.message}`);
                                }
                            } else {
                                console.log('宠物添加成功:', insertData);
                                
                                // 显示成功消息
                                showSuccessAnimation(petName);
                                
                                // 重新加载宠物列表
                                await loadPetList(user.id);
                                
                                // 关闭模态框
                                setTimeout(() => {
                                    closeModal();
                                }, 1500);
                            }
                            
                        } catch (error) {
                            console.error('保存宠物时发生异常:', error);
                            
                            // 提供更友好的错误提示
                            if (error.message.includes('supabaseClient is not defined')) {
                                alert('数据库连接失败，请检查网络连接或刷新页面重试');
                            } else if (error.message.includes('auth')) {
                                alert('用户认证失败，请重新登录');
                            } else {
                                alert(`保存失败: ${error.message}`);
                            }
                        } finally {
                            // 恢复按钮状态
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '保存';
                        }
                    });
            
            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 加载宠物列表
        async function loadPetList(userId) {
            try {
                const result = await SupabaseData.getPets(userId);
                
                if (result.success && result.data) {
                    await renderPetList(result.data);
                    
                    // 如果有宠物，加载第一个宠物的详情
                    if (result.data.length > 0) {
                        const firstPet = result.data[0];
                        renderPetDetail(firstPet);
                        await renderTimeline(firstPet.id);
                    } else {
                        // 如果没有宠物，显示提示信息
                        renderPetDetail(null);
                        document.getElementById('timeline-container').innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                                <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>暂无成长记录</p>
                            </div>
                        `;
                    }
                } else {
                    // 如果没有宠物数据，显示提示信息
                    const petCardsGrid = document.querySelector('.pet-cards-grid');
                    petCardsGrid.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-paw" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>您还没有添加任何宠物</p>
                            <p>点击"添加新宠物"按钮开始记录您的宠物信息</p>
                        </div>
                    `;
                    
                    // 显示空的宠物详情
                    renderPetDetail(null);
                    document.getElementById('timeline-container').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>暂无成长记录</p>
                        </div>
                    `;
                    
                    // 隐藏加载状态
                    hideLoadingState();
                }
            } catch (error) {
                console.error('加载宠物列表失败:', error);
                PawPals.showToast('加载宠物列表失败', 'error');
                
                // 显示错误状态
                showErrorState('加载宠物列表失败: ' + error.message);
            }
        }
        
        // 渲染宠物列表
        async function renderPetList(pets) {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            
            if (pets.length === 0) {
                petCardsGrid.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-paw" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>您还没有添加任何宠物</p>
                        <p>点击"添加新宠物"按钮开始记录您的宠物信息</p>
                    </div>
                `;
                
                // 隐藏加载状态
                hideLoadingState();
                return;
            }
            
            let html = '';
            
            pets.forEach(pet => {
                const petAvatar = pet.name.charAt(0);
                const petTypeText = getPetTypeText(pet.pet_type);
                const ageText = pet.birth_date ? calculateAge(pet.birth_date) : '未知年龄';
                
                html += `
                    <div class="pet-card" data-pet-id="${pet.id}">
                        <div class="pet-avatar">${petAvatar}</div>
                        <div class="pet-info">
                            <h3>${pet.name}</h3>
                            <p><i class="fas fa-${getPetIcon(pet.pet_type)}"></i> ${petTypeText}</p>
                            <p><i class="fas fa-birthday-cake"></i> ${ageText}</p>
                            ${pet.breed ? `<p><i class="fas fa-dna"></i> ${pet.breed}</p>` : ''}
                            <div class="pet-tags">
                                <span class="tag">#${getGenderText(pet.gender)}</span>
                            </div>
                        </div>
                        <div class="pet-actions">
                            <button class="action-btn view-btn">
                                <i class="fas fa-eye"></i>
                                查看详情
                            </button>
                        </div>
                    </div>
                `;
            });
            
            petCardsGrid.innerHTML = html;
            
            // 重新绑定事件
            bindPetCardEvents();
            
            // 隐藏加载状态
            hideLoadingState();
        }
        
        // 获取宠物类型显示文本
        function getPetTypeText(petType) {
            const typeMap = {
                'dog': '狗狗',
                'cat': '猫咪', 
                'rabbit': '兔子',
                'bird': '鸟类',
                'rodent': '啮齿类',
                'reptile': '爬行类',
                'other': '其他'
            };
            return typeMap[petType] || petType;
        }
        
        // 获取宠物图标
        function getPetIcon(petType) {
            const iconMap = {
                'dog': 'dog',
                'cat': 'cat',
                'rabbit': 'paw',
                'bird': 'dove',
                'rodent': 'mouse',
                'reptile': 'dragon',
                'other': 'paw'
            };
            return iconMap[petType] || 'paw';
        }
        
        // 获取性别显示文本
        function getGenderText(gender) {
            return gender === 'male' ? '公' : '母';
        }
        
        // 计算年龄
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const now = new Date();
            const diff = now - birth;
            const years = Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
            const months = Math.floor((diff % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
            
            if (years > 0) {
                return `${years}岁${months > 0 ? ` ${months}个月` : ''}`;
            } else {
                return `${months}个月`;
            }
        }
        
        // 绑定宠物卡片事件
        function bindPetCardEvents() {
            const petCards = document.querySelectorAll('.pet-card');
            
            console.log(`找到 ${petCards.length} 个宠物卡片，开始绑定事件...`);
            
            petCards.forEach(card => {
                // 卡片点击事件
                card.addEventListener('click', async function(e) {
                    // 阻止在点击操作按钮时触发卡片点击
                    if (!e.target.closest('.view-btn')) {
                        const petId = this.getAttribute('data-pet-id');
                        
                        // 获取宠物详细信息并更新页面右侧显示
                        try {
                            const pet = await getPetDetails(petId);
                            renderPetDetail(pet);
                            await renderTimeline(petId);
                            
                            // 同时显示模态框
                            showPetDetailModal(petId);
                        } catch (error) {
                            console.error('加载宠物详情失败:', error);
                            PawPals.showToast('加载宠物详情失败: ' + error.message, 'error');
                        }
                    }
                });
                
                // 查看详情按钮 - 确保按钮存在
                const viewBtn = card.querySelector('.view-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const petId = this.closest('.pet-card').getAttribute('data-pet-id');
                        
                        // 获取宠物详细信息并更新页面右侧显示
                        try {
                            const pet = await getPetDetails(petId);
                            renderPetDetail(pet);
                            await renderTimeline(petId);
                            
                            // 同时显示模态框
                            showPetDetailModal(petId);
                        } catch (error) {
                            console.error('加载宠物详情失败:', error);
                            PawPals.showToast('加载宠物详情失败: ' + error.message, 'error');
                        }
                    });
                } else {
                    console.warn('查看详情按钮未找到，跳过事件绑定');
                }
            });
            
            console.log('宠物卡片事件绑定完成');
        }

        // 根据宠物ID获取宠物详细信息
        async function getPetDetails(petId) {
            try {
                if (!window.supabaseClient) {
                    throw new Error('数据库连接未初始化');
                }
                
                const { data, error } = await window.supabaseClient
                    .from('pets')
                    .select('*')
                    .eq('id', petId)
                    .single();
                
                if (error) {
                    console.error('获取宠物详情失败:', error);
                    throw new Error('获取宠物详情失败: ' + error.message);
                }
                
                return data;
            } catch (error) {
                console.error('获取宠物详情时发生异常:', error);
                throw error;
            }
        }

        // 宠物详情模态框（修改为从数据库获取信息）
        async function showPetDetailModal(petId) {
            // 显示加载状态
            let modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>宠物详情</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">正在加载宠物信息...</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 绑定关闭事件
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            try {
                // 获取宠物详细信息
                const pet = await getPetDetails(petId);
                
                // 更新页面中的宠物详情
                renderPetDetail(pet);
                
                // 渲染时间线
                await renderTimeline(petId);
                
                // 计算年龄
                const ageText = pet.birth_date ? calculateAge(pet.birth_date) : '未知';
                
                // 生成个性标签HTML
                let tagsHtml = '';
                if (pet.personality_tags && Array.isArray(pet.personality_tags)) {
                    tagsHtml = pet.personality_tags.map(tag => 
                        `<span class="tag">#${tag}</span>`
                    ).join('');
                }
                
                // 生成健康信息HTML
                let healthInfoHtml = '';
                if (pet.weight) {
                    healthInfoHtml += `
                        <div class="health-item">
                            <span class="label">体重：</span>
                            <span class="value">${pet.weight}kg</span>
                        </div>`;
                }
                
                // 添加健康备注
                if (pet.health_notes) {
                    healthInfoHtml += `
                        <div class="health-item">
                            <span class="label">健康备注：</span>
                            <span class="value">${pet.health_notes}</span>
                        </div>`;
                }
                
                // 如果没有任何健康信息，显示默认信息
                if (!healthInfoHtml) {
                    healthInfoHtml = '<p>暂无健康信息记录</p>';
                }
                
                // 生成生活习惯HTML
                let habitsHtml = pet.living_habits ? 
                    `<p>${pet.living_habits}</p>` : 
                    '<p>暂无生活习惯记录</p>';
                
                // 更新模态框内容
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${pet.name} 的详细信息</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                                <div class="pet-avatar-large" style="background-color: ${pet.avatar_color || '#FF9800'}">
                                    ${pet.name.charAt(0)}
                                </div>
                                <div>
                                    <h4>${pet.name}</h4>
                                    <p><i class="fas fa-${getPetIcon(pet.pet_type)}"></i> ${getPetTypeText(pet.pet_type)}</p>
                                    <p><i class="fas fa-${pet.gender === 'male' ? 'mars' : 'venus'}"></i> ${getGenderText(pet.gender)}</p>
                                    <p><i class="fas fa-birthday-cake"></i> ${ageText}</p>
                                    ${pet.breed ? `<p><i class="fas fa-dna"></i> ${pet.breed}</p>` : ''}
                                    <div class="pet-tags">
                                        ${tagsHtml}
                                    </div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4><i class="fas fa-heart"></i> 健康信息</h4>
                                <div class="health-info">
                                    ${healthInfoHtml}
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4><i class="fas fa-home"></i> 生活习性</h4>
                                <div class="habit-info">
                                    ${habitsHtml}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="action-btn edit-pet-btn" data-pet-id="${pet.id}">
                                <i class="fas fa-edit"></i> 编辑信息
                            </button>
                            <button class="action-btn add-record-btn" data-pet-id="${pet.id}">
                                <i class="fas fa-plus"></i> 添加记录
                            </button>
                            <button class="close-btn">关闭</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const newCloseBtns = modal.querySelectorAll('.close-btn');
                newCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // 绑定编辑按钮事件
                const editBtn = modal.querySelector('.edit-pet-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const petId = this.getAttribute('data-pet-id');
                        document.body.removeChild(modal);
                        showEditPetModal(petId);
                    });
                }
                
                // 绑定添加记录按钮事件
                const addRecordBtn = modal.querySelector('.add-record-btn');
                if (addRecordBtn) {
                    addRecordBtn.addEventListener('click', function() {
                        const petId = this.getAttribute('data-pet-id');
                        document.body.removeChild(modal);
                        showAddRecordModal(petId);
                    });
                }
                
            } catch (error) {
                console.error('加载宠物详情失败:', error);
                // 显示错误信息
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>加载失败</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 2rem; color: #f44336;">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>无法加载宠物详情</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="close-btn">关闭</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const errorCloseBtns = modal.querySelectorAll('.close-btn');
                errorCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
        }
        
        // 添加记录模态框
        async function showAddRecordModal(petId) {
            // 首先获取宠物信息
            let pet;
            try {
                pet = await getPetDetails(petId);
            } catch (error) {
                console.error('获取宠物信息失败:', error);
                PawPals.showToast('获取宠物信息失败: ' + error.message, 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>为 ${pet.name} 添加记录</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <form id="addRecordForm">
                            <input type="hidden" id="petId" value="${petId}">
                            <div class="form-group">
                                <label for="recordTitle">记录标题</label>
                                <input type="text" id="recordTitle" placeholder="请输入记录标题" required>
                            </div>
                            <div class="form-group">
                                <label for="recordType">记录类型</label>
                                <select id="recordType" required>
                                    <option value="">请选择记录类型</option>
                                    <option value="health">健康记录</option>
                                    <option value="growth">成长记录</option>
                                    <option value="training">训练记录</option>
                                    <option value="activity">活动记录</option>
                                    <option value="other">其他记录</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recordDate">记录日期</label>
                                <input type="date" id="recordDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label for="recordContent">记录内容</label>
                                <textarea id="recordContent" placeholder="请输入记录的详细内容" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="recordPhotos">照片 (可选)</label>
                                <input type="file" id="recordPhotos" accept="image/*" multiple>
                                <div id="photoPreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="cancel-btn" type="button">取消</button>
                        <button class="submit-btn" type="button" id="saveRecordBtn">保存记录</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 照片预览功能
            const photoInput = modal.querySelector('#recordPhotos');
            const photoPreview = modal.querySelector('#photoPreview');
            
            photoInput.addEventListener('change', function() {
                photoPreview.innerHTML = '';
                
                if (this.files) {
                    Array.from(this.files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '80px';
                                img.style.height = '80px';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '4px';
                                photoPreview.appendChild(img);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });
            
            // 关闭功能
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            const cancelBtn = modal.querySelector('.cancel-btn');
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 保存记录功能
            const saveBtn = modal.querySelector('#saveRecordBtn');
            saveBtn.addEventListener('click', async function() {
                // 获取表单数据
                const title = modal.querySelector('#recordTitle').value;
                const type = modal.querySelector('#recordType').value;
                const date = modal.querySelector('#recordDate').value;
                const content = modal.querySelector('#recordContent').value;
                
                // 表单验证
                if (!title) {
                    PawPals.showToast('请输入记录标题', 'error');
                    return;
                }
                
                if (!type) {
                    PawPals.showToast('请选择记录类型', 'error');
                    return;
                }
                
                if (!date) {
                    PawPals.showToast('请选择记录日期', 'error');
                    return;
                }
                
                if (!content) {
                    PawPals.showToast('请输入记录内容', 'error');
                    return;
                }
                
                // 禁用按钮显示加载状态
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                
                try {
                    // 获取当前用户
                    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
                    
                    if (userError) {
                        throw new Error('用户认证失败: ' + userError.message);
                    }
                    
                    if (!user) {
                        throw new Error('用户未登录');
                    }
                    
                    // 构建记录数据
                    const recordData = {
                        pet_id: petId,
                        title: title,
                        record_type: type,
                        record_date: date,
                        content: content,
                        attachments: [], // 照片附件暂时留空，后续可以扩展
                        is_public: false, // 默认设为私有
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    console.log('准备保存记录数据:', recordData);
                    
                    // 保存到pet_records表
                    const { data: insertData, error: insertError } = await window.supabaseClient
                        .from('pet_records')
                        .insert([recordData])
                        .select();
                    
                    if (insertError) {
                        console.error('添加记录失败:', insertError);
                        throw new Error('添加记录失败: ' + insertError.message);
                    }
                    
                    console.log('记录添加成功:', insertData);
                    
                    // 显示成功消息
                    PawPals.showToast('记录添加成功！', 'success');
                    
                    // 关闭模态框
                    document.body.removeChild(modal);
                    
                    // 重新加载时间线
                    await renderTimeline(petId);
                    
                } catch (error) {
                    console.error('保存记录时发生异常:', error);
                    PawPals.showToast('保存失败: ' + error.message, 'error');
                } finally {
                    // 恢复按钮状态
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '保存记录';
                }
            });
        }
        
        // 时间线详情模态框
        function showTimelineDetailModal(title, content, date) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--text-light); margin-bottom: 10px;">记录日期：${date}</p>
                        <p style="line-height: 1.6;">${content}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="close-btn">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 关闭功能
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 状态显示函数 - 必须添加这些函数定义
        function showLoadingState() {
            const loadingDiv = document.getElementById('loading-pets');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载宠物列表...</p>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">
                        正在连接数据库，请稍候...
                    </p>
                `;
                loadingDiv.style.display = 'block';
            }
        }
        
        function showDatabaseError() {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>数据库连接失败</h3>
                        <p>无法连接到宠物数据库，请检查以下问题：</p>
                        <ul style="text-align: left; margin: 1rem auto; max-width: 400px;">
                            <li>网络连接是否正常</li>
                            <li>Supabase项目配置是否正确</li>
                            <li>数据库表是否已创建</li>
                        </ul>
                        <button class="action-btn" onclick="location.reload()">
                            <i class="fas fa-redo"></i>
                            重新加载页面
                        </button>
                    </div>
                `;
            }
        }
        
        function showLoginPrompt() {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="login-prompt" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-user-lock" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>请先登录</h3>
                        <p>查看宠物档案需要登录您的账户</p>
                        <button class="action-btn" onclick="window.location.href='auth.html'">
                            <i class="fas fa-sign-in-alt"></i>
                            去登录
                        </button>
                    </div>
                `;
            }
        }
        
        function showErrorState(message) {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>系统错误</h3>
                        <p>${message}</p>
                        <button class="action-btn" onclick="location.reload()">
                            <i class="fas fa-redo"></i>
                            刷新页面
                        </button>
                    </div>
                `;
            }
        }
        
        // 隐藏加载状态
        function hideLoadingState() {
            const loadingDiv = document.getElementById('loading-pets');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }
        
        // 显示成功动画
        function showSuccessAnimation(petName) {
            PawPals.showToast(`${petName} 添加成功！`);
        }
        
        // 渲染宠物详情
        function renderPetDetail(pet) {
            const container = document.getElementById('pet-detail-container');
            
            if (!pet) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-paw" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>请选择一个宠物查看详细信息</p>
                    </div>
                `;
                return;
            }
            
            // 计算年龄
            const ageText = pet.birth_date ? calculateAge(pet.birth_date) : '未知';
            
            // 生成个性标签HTML
            let tagsHtml = '';
            if (pet.personality_tags && Array.isArray(pet.personality_tags)) {
                tagsHtml = pet.personality_tags.map(tag => 
                    `<span class="tag">#${tag}</span>`
                ).join('');
            }
            
            // 生成健康信息HTML
            let healthInfoHtml = '';
            if (pet.weight) {
                healthInfoHtml += `
                    <div class="health-item">
                        <span class="label">体重：</span>
                        <span class="value">${pet.weight}kg</span>
                    </div>`;
            }
            
            // 添加健康备注
            if (pet.health_notes) {
                healthInfoHtml += `
                    <div class="health-item">
                        <span class="label">健康备注：</span>
                        <span class="value">${pet.health_notes}</span>
                    </div>`;
            }
            
            // 如果没有任何健康信息，显示默认信息
            if (!healthInfoHtml) {
                healthInfoHtml = '<p>暂无健康信息记录</p>';
            }
            
            // 生成生活习惯HTML
            let habitsHtml = pet.living_habits ? 
                `<p>${pet.living_habits}</p>` : 
                '<p>暂无生活习惯记录</p>';
            
            // 渲染宠物详情
            container.innerHTML = `
                <div class="pet-header">
                    <div class="pet-avatar-large" style="background-color: ${pet.avatar_color || '#FF9800'}">
                        ${pet.name.charAt(0)}
                    </div>
                    <div class="pet-basic-info">
                        <h2>${pet.name}</h2>
                        <div class="pet-meta">
                            <span><i class="fas fa-${getPetIcon(pet.pet_type)}"></i> ${getPetTypeText(pet.pet_type)}</span>
                            <span><i class="fas fa-${pet.gender === 'male' ? 'mars' : 'venus'}"></i> ${getGenderText(pet.gender)}</span>
                            <span><i class="fas fa-birthday-cake"></i> ${ageText}</span>
                            ${pet.birth_date ? `<span><i class="fas fa-calendar"></i> ${pet.birth_date}</span>` : ''}
                        </div>
                        <div class="pet-tags">
                            ${tagsHtml}
                        </div>
                    </div>
                </div>
                
                <div class="pet-details">
                    <div class="detail-section">
                        <h3><i class="fas fa-heart"></i> 健康信息</h3>
                        <div class="health-info">
                            ${healthInfoHtml}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3><i class="fas fa-home"></i> 生活习性</h3>
                        <div class="habit-info">
                            ${habitsHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 渲染时间线（从数据库获取真实数据）
        async function renderTimeline(petId) {
            const container = document.getElementById('timeline-container');
            
            // 显示加载状态
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                    <p style="margin-top: 1rem;">正在加载成长记录...</p>
                </div>
            `;
            
            try {
                // 从数据库获取宠物记录
                const result = await SupabaseData.getPetRecords(petId);
                
                if (result.success && result.data && result.data.length > 0) {
                    // 按日期排序
                    const records = result.data.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                    
                    let html = '';
                    records.forEach(record => {
                        // 格式化日期
                        const recordDate = new Date(record.record_date);
                        const formattedDate = recordDate.toLocaleDateString('zh-CN');
                        
                        // 获取记录类型显示文本
                        const recordTypeText = {
                            'health': '健康记录',
                            'growth': '成长记录',
                            'training': '训练记录',
                            'activity': '活动记录',
                            'other': '其他记录'
                        }[record.record_type] || '记录';
                        
                        html += `
                            <div class="timeline-item" data-record-id="${record.id}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <h4>${record.title || recordTypeText}</h4>
                                    <p>${record.content || '暂无内容'}</p>
                                    <span class="timeline-date">${formattedDate}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // 绑定时间线项点击事件
                    const timelineItems = document.querySelectorAll('.timeline-item');
                    timelineItems.forEach(item => {
                        item.addEventListener('click', function() {
                            const title = this.querySelector('h4').textContent;
                            const content = this.querySelector('p').textContent;
                            const date = this.querySelector('.timeline-date').textContent;
                            
                            PawPals.showToast(`查看 ${date} 的 ${title} 记录`);
                            showTimelineDetailModal(title, content, date);
                        });
                    });
                } else {
                    // 没有记录时显示提示
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>暂无成长记录</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">点击"添加记录"按钮为您的宠物添加第一条记录</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载成长记录失败:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>加载成长记录失败</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 绑定宠物卡片事件
        function bindPetCardEvents() {
            const petCards = document.querySelectorAll('.pet-card');
            
            console.log(`找到 ${petCards.length} 个宠物卡片，开始绑定事件...`);
            
            petCards.forEach(card => {
                // 卡片点击事件
                card.addEventListener('click', async function(e) {
                    // 阻止在点击操作按钮时触发卡片点击
                    if (!e.target.closest('.view-btn')) {
                        const petId = this.getAttribute('data-pet-id');
                        
                        // 获取宠物详细信息并更新页面右侧显示
                        try {
                            const pet = await getPetDetails(petId);
                            renderPetDetail(pet);
                            await renderTimeline(petId);
                            
                            // 同时显示模态框
                            showPetDetailModal(petId);
                        } catch (error) {
                            console.error('加载宠物详情失败:', error);
                            PawPals.showToast('加载宠物详情失败: ' + error.message, 'error');
                        }
                    }
                });
                
                // 查看详情按钮 - 确保按钮存在
                const viewBtn = card.querySelector('.view-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const petId = this.closest('.pet-card').getAttribute('data-pet-id');
                        
                        // 获取宠物详细信息并更新页面右侧显示
                        try {
                            const pet = await getPetDetails(petId);
                            renderPetDetail(pet);
                            await renderTimeline(petId);
                            
                            // 同时显示模态框
                            showPetDetailModal(petId);
                        } catch (error) {
                            console.error('加载宠物详情失败:', error);
                            PawPals.showToast('加载宠物详情失败: ' + error.message, 'error');
                        }
                    });
                } else {
                    console.warn('查看详情按钮未找到，跳过事件绑定');
                }
            });
            
            console.log('宠物卡片事件绑定完成');
        }

        // 根据宠物ID获取宠物详细信息
        async function getPetDetails(petId) {
            try {
                if (!window.supabaseClient) {
                    throw new Error('数据库连接未初始化');
                }
                
                const { data, error } = await window.supabaseClient
                    .from('pets')
                    .select('*')
                    .eq('id', petId)
                    .single();
                
                if (error) {
                    console.error('获取宠物详情失败:', error);
                    throw new Error('获取宠物详情失败: ' + error.message);
                }
                
                return data;
            } catch (error) {
                console.error('获取宠物详情时发生异常:', error);
                throw error;
            }
        }

        // 宠物详情模态框（修改为从数据库获取信息）
        async function showPetDetailModal(petId) {
            // 显示加载状态
            let modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>宠物详情</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">正在加载宠物信息...</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 绑定关闭事件
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            try {
                // 获取宠物详细信息
                const pet = await getPetDetails(petId);
                
                // 计算年龄
                const ageText = pet.birth_date ? calculateAge(pet.birth_date) : '未知';
                
                // 生成个性标签HTML
                let tagsHtml = '';
                if (pet.personality_tags && Array.isArray(pet.personality_tags)) {
                    tagsHtml = pet.personality_tags.map(tag => 
                        `<span class="tag">#${tag}</span>`
                    ).join('');
                }
                
                // 生成健康信息HTML
                let healthInfoHtml = '';
                if (pet.weight) {
                    healthInfoHtml += `
                        <div class="health-item">
                            <span class="label">体重：</span>
                            <span class="value">${pet.weight}kg</span>
                        </div>`;
                }
                
                // 添加健康备注
                if (pet.health_notes) {
                    healthInfoHtml += `
                        <div class="health-item">
                            <span class="label">健康备注：</span>
                            <span class="value">${pet.health_notes}</span>
                        </div>`;
                }
                
                // 如果没有任何健康信息，显示默认信息
                if (!healthInfoHtml) {
                    healthInfoHtml = '<p>暂无健康信息记录</p>';
                }
                
                // 生成生活习惯HTML
                let habitsHtml = pet.living_habits ? 
                    `<p>${pet.living_habits}</p>` : 
                    '<p>暂无生活习惯记录</p>';
                
                // 更新模态框内容
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${pet.name} 的详细信息</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                                <div class="pet-avatar-large" style="background-color: ${pet.avatar_color || '#FF9800'}">
                                    ${pet.name.charAt(0)}
                                </div>
                                <div>
                                    <h4>${pet.name}</h4>
                                    <p><i class="fas fa-${getPetIcon(pet.pet_type)}"></i> ${getPetTypeText(pet.pet_type)}</p>
                                    <p><i class="fas fa-${pet.gender === 'male' ? 'mars' : 'venus'}"></i> ${getGenderText(pet.gender)}</p>
                                    <p><i class="fas fa-birthday-cake"></i> ${ageText}</p>
                                    ${pet.breed ? `<p><i class="fas fa-dna"></i> ${pet.breed}</p>` : ''}
                                    <div class="pet-tags">
                                        ${tagsHtml}
                                    </div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4><i class="fas fa-heart"></i> 健康信息</h4>
                                <div class="health-info">
                                    ${healthInfoHtml}
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4><i class="fas fa-home"></i> 生活习性</h4>
                                <div class="habit-info">
                                    ${habitsHtml}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="action-btn edit-pet-btn" data-pet-id="${pet.id}">
                                <i class="fas fa-edit"></i> 编辑信息
                            </button>
                            <button class="action-btn add-record-btn" data-pet-id="${pet.id}">
                                <i class="fas fa-plus"></i> 添加记录
                            </button>
                            <button class="close-btn">关闭</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const newCloseBtns = modal.querySelectorAll('.close-btn');
                newCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // 绑定编辑按钮事件
                const editBtn = modal.querySelector('.edit-pet-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const petId = this.getAttribute('data-pet-id');
                        document.body.removeChild(modal);
                        showEditPetModal(petId);
                    });
                }
                
                // 绑定添加记录按钮事件
                const addRecordBtn = modal.querySelector('.add-record-btn');
                if (addRecordBtn) {
                    addRecordBtn.addEventListener('click', function() {
                        const petId = this.getAttribute('data-pet-id');
                        document.body.removeChild(modal);
                        showAddRecordModal(petId);
                    });
                }
                
            } catch (error) {
                console.error('加载宠物详情失败:', error);
                // 显示错误信息
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>加载失败</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 2rem; color: #f44336;">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>无法加载宠物详情</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="close-btn">关闭</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const errorCloseBtns = modal.querySelectorAll('.close-btn');
                errorCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
        }
        
        // 时间线详情模态框
        function showTimelineDetailModal(title, content, date) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--text-light); margin-bottom: 10px;">记录日期：${date}</p>
                        <p style="line-height: 1.6;">${content}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="close-btn">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 关闭功能
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 状态显示函数 - 必须添加这些函数定义
        function showLoadingState() {
            const loadingDiv = document.getElementById('loading-pets');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载宠物列表...</p>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">
                        正在连接数据库，请稍候...
                    </p>
                `;
                loadingDiv.style.display = 'block';
            }
        }
        
        function showDatabaseError() {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>数据库连接失败</h3>
                        <p>无法连接到宠物数据库，请检查以下问题：</p>
                        <ul style="text-align: left; margin: 1rem auto; max-width: 400px;">
                            <li>网络连接是否正常</li>
                            <li>Supabase项目配置是否正确</li>
                            <li>数据库表是否已创建</li>
                        </ul>
                        <button class="action-btn" onclick="location.reload()">
                            <i class="fas fa-redo"></i>
                            重新加载页面
                        </button>
                    </div>
                `;
            }
        }
        
        function showLoginPrompt() {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="login-prompt" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-user-lock" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>请先登录</h3>
                        <p>查看宠物档案需要登录您的账户</p>
                        <button class="action-btn" onclick="window.location.href='auth.html'">
                            <i class="fas fa-sign-in-alt"></i>
                            去登录
                        </button>
                    </div>
                `;
            }
        }
        
        function showErrorState(message) {
            const petCardsGrid = document.querySelector('.pet-cards-grid');
            if (petCardsGrid) {
                petCardsGrid.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>系统错误</h3>
                        <p>${message}</p>
                        <button class="action-btn" onclick="location.reload()">
                            <i class="fas fa-redo"></i>
                            刷新页面
                        </button>
                    </div>
                `;
            }
        }
        
        // 隐藏加载状态
        function hideLoadingState() {
            const loadingDiv = document.getElementById('loading-pets');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }
        
        // 编辑宠物信息模态框
        async function showEditPetModal(petId) {
            // 显示加载状态
            let modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>编辑宠物信息</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">正在加载宠物信息...</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 绑定关闭事件
            const closeBtns = modal.querySelectorAll('.close-btn');
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            try {
                // 获取宠物详细信息
                const pet = await getPetDetails(petId);
                
                // 生成编辑表单
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>编辑 ${pet.name} 的信息</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <form id="editPetForm">
                                <input type="hidden" id="petId" value="${pet.id}">
                                <div class="form-group">
                                    <label for="editPetName">宠物名称</label>
                                    <input type="text" id="editPetName" value="${pet.name}" placeholder="请输入宠物名称" required>
                                </div>
                                <div class="form-group">
                                    <label for="editPetType">宠物类型</label>
                                    <select id="editPetType" required>
                                        <option value="">请选择宠物类型</option>
                                        <option value="dog" ${pet.pet_type === 'dog' ? 'selected' : ''}>狗狗</option>
                                        <option value="cat" ${pet.pet_type === 'cat' ? 'selected' : ''}>猫咪</option>
                                        <option value="rabbit" ${pet.pet_type === 'rabbit' ? 'selected' : ''}>兔子</option>
                                        <option value="bird" ${pet.pet_type === 'bird' ? 'selected' : ''}>鸟类</option>
                                        <option value="rodent" ${pet.pet_type === 'rodent' ? 'selected' : ''}>啮齿类</option>
                                        <option value="reptile" ${pet.pet_type === 'reptile' ? 'selected' : ''}>爬行类</option>
                                        <option value="other" ${pet.pet_type === 'other' ? 'selected' : ''}>其他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editPetBreed">品种</label>
                                    <input type="text" id="editPetBreed" value="${pet.breed || ''}" placeholder="请输入品种">
                                </div>
                                <div class="form-group">
                                    <label for="editPetBirthday">生日</label>
                                    <input type="date" id="editPetBirthday" value="${pet.birth_date || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editPetGender">性别</label>
                                    <select id="editPetGender">
                                        <option value="">请选择性别</option>
                                        <option value="male" ${pet.gender === 'male' ? 'selected' : ''}>公</option>
                                        <option value="female" ${pet.gender === 'female' ? 'selected' : ''}>母</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editPetWeight">体重 (kg)</label>
                                    <input type="number" id="editPetWeight" step="0.1" min="0" value="${pet.weight || ''}" placeholder="请输入体重">
                                </div>
                                <div class="form-group">
                                    <label for="editHealthNotes">健康备注</label>
                                    <textarea id="editHealthNotes" placeholder="请输入健康相关信息">${pet.health_notes || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editLivingHabits">生活习惯</label>
                                    <textarea id="editLivingHabits" placeholder="请输入宠物的生活习惯">${pet.living_habits || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="cancel-btn" type="button">取消</button>
                            <button class="submit-btn" type="button" id="savePetBtn">保存</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const newCloseBtns = modal.querySelectorAll('.close-btn');
                newCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                const cancelBtn = modal.querySelector('.cancel-btn');
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // 绑定保存按钮事件
                const saveBtn = modal.querySelector('#savePetBtn');
                saveBtn.addEventListener('click', async function() {
                    // 获取表单数据
                    const petId = document.getElementById('petId').value;
                    const petName = document.getElementById('editPetName').value;
                    const petType = document.getElementById('editPetType').value;
                    const petBreed = document.getElementById('editPetBreed').value;
                    const petBirthday = document.getElementById('editPetBirthday').value;
                    const petGender = document.getElementById('editPetGender').value;
                    const petWeight = document.getElementById('editPetWeight').value;
                    const healthNotes = document.getElementById('editHealthNotes').value;
                    const livingHabits = document.getElementById('editLivingHabits').value;
                    
                    // 表单验证
                    if (!petName) {
                        alert('请填写宠物名称');
                        return;
                    }
                    
                    if (!petType) {
                        alert('请选择宠物类型');
                        return;
                    }
                    
                    if (!petGender) {
                        alert('请选择宠物性别');
                        return;
                    }
                    
                    // 禁用按钮显示加载状态
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                    
                    try {
                        // 构建更新数据
                        const updateData = {
                            name: petName,
                            pet_type: petType,
                            breed: petBreed || '',
                            gender: petGender,
                            birth_date: petBirthday || null,
                            weight: petWeight ? parseFloat(petWeight) : null,
                            health_notes: healthNotes || '',
                            living_habits: livingHabits || '',
                            updated_at: new Date().toISOString()
                        };
                        
                        // 更新数据库中的宠物信息
                        const { data, error } = await window.supabaseClient
                            .from('pets')
                            .update(updateData)
                            .eq('id', petId)
                            .select()
                            .single();
                        
                        if (error) {
                            throw new Error('更新失败: ' + error.message);
                        }
                        
                        console.log('宠物信息更新成功:', data);
                        
                        // 显示成功消息
                        PawPals.showToast('宠物信息更新成功', 'success');
                        
                        // 关闭模态框
                        document.body.removeChild(modal);
                        
                        // 重新加载宠物列表和详情
                        const { data: { user } } = await supabaseClient.auth.getUser();
                        if (user) {
                            await loadPetList(user.id);
                        }
                        
                    } catch (error) {
                        console.error('保存宠物信息时发生异常:', error);
                        alert(`保存失败: ${error.message}`);
                    } finally {
                        // 恢复按钮状态
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '保存';
                    }
                });
                
            } catch (error) {
                console.error('加载宠物详情失败:', error);
                // 显示错误信息
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>加载失败</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 2rem; color: #f44336;">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>无法加载宠物详情</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="close-btn">关闭</button>
                        </div>
                    </div>
                `;
                
                // 重新绑定关闭事件
                const errorCloseBtns = modal.querySelectorAll('.close-btn');
                errorCloseBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
        }
        
    </script>
</body>
</html>