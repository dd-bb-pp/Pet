<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•/æ³¨å†Œ - PawPals</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- å¼•å…¥Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="auth-body">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-paw"></i>
                <span>PawPals</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> é¦–é¡µ</a></li>
                <li><a href="pet-profile.html" class="nav-link"><i class="fas fa-id-card"></i> å® ç‰©æ¡£æ¡ˆ</a></li>
                <li><a href="community.html" class="nav-link"><i class="fas fa-users"></i> åŒåŸåŠ¨æ€</a></li>
                <li><a href="auth.html" class="nav-link active" id="authLink"><i class="fas fa-user"></i> ç™»å½•/æ³¨å†Œ</a></li>
            </ul>
        </div>
    </nav>

    <!-- è®¤è¯é¡µé¢ä¸»å†…å®¹ -->
    <main class="auth-container">
        <div class="container">
            <div class="auth-card">
                <!-- æ ‡ç­¾åˆ‡æ¢ -->
                <div class="auth-tabs">
                    <button class="tab-btn active" data-tab="login">ç™»å½•</button>
                    <button class="tab-btn" data-tab="register">æ³¨å†Œ</button>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div class="tab-content active" id="loginTab">
                    <h2>æ¬¢è¿å›æ¥</h2>
                    <p class="auth-subtitle">ç™»å½•æ‚¨çš„PawPalsè´¦æˆ·</p>
                    
                    <form class="auth-form" id="loginForm">
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="loginEmail" placeholder="é‚®ç®±åœ°å€" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="loginPassword" placeholder="å¯†ç " required>
                            </div>
                        </div>
                        
                        <div class="form-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="rememberMe">
                                <span class="checkmark"></span>
                                è®°ä½æˆ‘
                            </label>
                            <a href="#" class="forgot-password">å¿˜è®°å¯†ç ï¼Ÿ</a>
                        </div>
                        
                        <button type="submit" class="auth-btn primary">
                            <i class="fas fa-sign-in-alt"></i>
                            ç™»å½•
                        </button>
                    </form>
                    
                    <div class="auth-divider">
                        <span>æˆ–</span>
                    </div>
                    
                    <div class="social-login">
                        <button class="social-btn wechat">
                            <i class="fab fa-weixin"></i>
                            å¾®ä¿¡ç™»å½•
                        </button>
                        <button class="social-btn qq">
                            <i class="fab fa-qq"></i>
                            QQç™»å½•
                        </button>
                    </div>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div class="tab-content" id="registerTab">
                    <h2>åˆ›å»ºè´¦æˆ·</h2>
                    <p class="auth-subtitle">åŠ å…¥PawPalså® ç‰©ç¤¾åŒº</p>
                    
                    <form class="auth-form" id="registerForm">
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" id="registerName" placeholder="ç”¨æˆ·å" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="registerEmail" placeholder="é‚®ç®±åœ°å€" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="registerPassword" placeholder="å¯†ç " required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="confirmPassword" placeholder="ç¡®è®¤å¯†ç " required>
                            </div>
                        </div>
                        
                        <div class="form-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="agreeTerms" required>
                                <span class="checkmark"></span>
                                æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" class="terms-link">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="#" class="terms-link">éšç§æ”¿ç­–</a>
                            </label>
                        </div>
                        
                        <button type="submit" class="auth-btn secondary">
                            <i class="fas fa-user-plus"></i>
                            æ³¨å†Œ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>å…³äºæˆ‘ä»¬</h3>
                    <p>PawPals è‡´åŠ›äºä¸ºå® ç‰©ä¸»äººæä¾›å…¨æ–¹ä½çš„ç¤¾äº¤å’ŒæœåŠ¡å¹³å°</p>
                </div>
                <div class="footer-section">
                    <h3>è”ç³»æ–¹å¼</h3>
                    <p>é‚®ç®±ï¼šcontact@pawpals.com</p>
                    <p>ç”µè¯ï¼š400-123-4567</p>
                </div>
                <div class="footer-section">
                    <h3>éšç§æ”¿ç­–</h3>
                    <p>æˆ‘ä»¬ä¸¥æ ¼ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œç¡®ä¿ä¿¡æ¯å®‰å…¨</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PawPals. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
            </div>
        </div>
    </footer>

    <!-- å¼•å…¥Supabaseé…ç½®å’ŒåŠŸèƒ½ -->
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script>
        // ç­‰å¾…æ•°æ®åº“è¿æ¥å®Œæˆçš„å‡½æ•°
        async function waitForDatabaseConnection(maxWaitTime = 5000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                
                const checkConnection = () => {
                    if (window.supabaseClient && window.databaseInitialized) {
                        console.log('æ•°æ®åº“è¿æ¥å·²å°±ç»ª');
                        resolve(true);
                        return;
                    }
                    
                    if (Date.now() - startTime > maxWaitTime) {
                        console.warn('ç­‰å¾…æ•°æ®åº“è¿æ¥è¶…æ—¶ï¼Œå°†ä½¿ç”¨åŸºç¡€åŠŸèƒ½');
                        resolve(false);
                        return;
                    }
                    
                    setTimeout(checkConnection, 100);
                };
                
                checkConnection();
            });
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        async function checkUserLoggedIn() {
            if (!window.supabaseClient) {
                console.warn('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return null;
            }
            
            try {
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
                return null;
            }
        }
        
        // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤ºå·²ç™»å½•ç”¨æˆ·ä¿¡æ¯
        function updateNavbarForLoggedInUser(user) {
            const authLink = document.querySelector('.nav-menu a[href="auth.html"]');
            if (authLink) {
                // è·å–ç”¨æˆ·åï¼ˆä¼˜å…ˆä½¿ç”¨display_nameï¼Œå¦åˆ™ä½¿ç”¨emailå‰ç¼€ï¼‰
                const username = user.user_metadata?.display_name || 
                                user.email?.split('@')[0] || 
                                'ç”¨æˆ·';
                
                authLink.innerHTML = `<i class="fas fa-user"></i> ${username}`;
                authLink.href = '#';
                authLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·èœå•æˆ–ä¸ªäººé¡µé¢é“¾æ¥
                    if (typeof alert !== 'undefined') {
                        alert(`æ¬¢è¿ï¼Œ${username}ï¼`);
                    }
                });
            }
        }
        
        // æ˜¾ç¤ºè¿æ¥è¯Šæ–­ä¿¡æ¯
        function showConnectionDiagnostics() {
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
            console.log('=== æ•°æ®åº“è¿æ¥è¯Šæ–­ ===');
            console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
            console.log('Supabaseå®¢æˆ·ç«¯çŠ¶æ€:', window.supabaseClient ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
            console.log('æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€:', window.databaseInitialized);
            
            if (window.supabaseClient) {
                console.log('Supabase URL:', window.supabaseClient.supabaseUrl);
            }
            
            // æ˜¾ç¤ºé¡µé¢URLä¿¡æ¯
            if (typeof window !== 'undefined' && window.location) {
                console.log('å½“å‰é¡µé¢URL:', window.location.href);
                console.log('é¡µé¢åè®®:', window.location.protocol);
                console.log('é¡µé¢åŸŸå:', window.location.hostname);
            }
            
            // æç¤ºç”¨æˆ·æŸ¥çœ‹æ§åˆ¶å°
            if (typeof alert !== 'undefined') {
                alert('è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸­çš„è¯¦ç»†è¯Šæ–­ä¿¡æ¯ã€‚');
            }
        }
        
        // è®¤è¯é¡µé¢ç‰¹å®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆè°ƒç”¨Supabaseåˆå§‹åŒ–
            await initPageSupabase();
            
            // ç­‰å¾…æ•°æ®åº“è¿æ¥å®Œæˆ
            const dbReady = await waitForDatabaseConnection();
            
            if (!dbReady) {
                console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥');
                console.log('ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š');
                console.log('  1. ç½‘ç»œè¿æ¥é—®é¢˜');
                console.log('  2. SupabaseæœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
                console.log('  3. éƒ¨ç½²ç¯å¢ƒçš„CORSé™åˆ¶');
                console.log('  4. APIå¯†é’¥é…ç½®é—®é¢˜');
                
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                PawPals.showToast('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•', 'error');
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœå·²ç™»å½•åˆ™é‡å®šå‘åˆ°é¦–é¡µ
            const user = await checkUserLoggedIn();
            if (user) {
                console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œé‡å®šå‘åˆ°é¦–é¡µ');
                // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                updateNavbarForLoggedInUser(user);
                window.location.href = 'index.html';
                return;
            }
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    this.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });

            // ç™»å½•è¡¨å•æäº¤
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const submitBtn = this.querySelector('button[type="submit"]');
                
                const errors = PawPals.validateForm({
                    email: email,
                    password: password
                });
                
                if (errors.length > 0) {
                    PawPals.showToast(errors[0]);
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å½•ä¸­...';
                
                try {
                    const result = await SupabaseAuth.signIn(email, password);
                    
                    if (result.success) {
                        PawPals.showToast('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    } else {
                        PawPals.showToast(result.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ç™»å½•';
                    }
                } catch (error) {
                    console.error('ç™»å½•å¼‚å¸¸:', error);
                    PawPals.showToast('ç™»å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ç™»å½•';
                }
            });

            // æ³¨å†Œè¡¨å•æäº¤
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const submitBtn = this.querySelector('button[type="submit"]');
                
                const errors = PawPals.validateForm({
                    email: email,
                    password: password,
                    confirmPassword: confirmPassword
                });
                
                if (password !== confirmPassword) {
                    PawPals.showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                
                if (!document.getElementById('agreeTerms').checked) {
                    PawPals.showToast('è¯·åŒæ„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–');
                    return;
                }
                
                if (errors.length > 0) {
                    PawPals.showToast(errors[0]);
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ³¨å†Œä¸­...';
                
                try {
                    const result = await SupabaseAuth.signUp(email, password, name);
                    
                    if (result.success) {
                        if (result.data.user && result.data.user.identities && result.data.user.identities.length > 0) {
                            // ç›´æ¥æ³¨å†ŒæˆåŠŸ
                            PawPals.showToast('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯é‚®ä»¶åç™»å½•');
                            setTimeout(() => {
                                document.querySelector('[data-tab="login"]').click();
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> æ³¨å†Œ';
                            }, 2000);
                        } else {
                            // éœ€è¦é‚®ç®±éªŒè¯
                            PawPals.showToast('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯é‚®ä»¶');
                            setTimeout(() => {
                                document.querySelector('[data-tab="login"]').click();
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> æ³¨å†Œ';
                            }, 2000);
                        }
                    } else {
                        PawPals.showToast(result.error || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> æ³¨å†Œ';
                    }
                } catch (error) {
                    console.error('æ³¨å†Œå¼‚å¸¸:', error);
                    PawPals.showToast('æ³¨å†Œæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> æ³¨å†Œ';
                }
            });

            // ç¤¾äº¤ç™»å½•æŒ‰é’®
            const socialBtns = document.querySelectorAll('.social-btn');
            socialBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.classList.contains('wechat') ? 'å¾®ä¿¡' : 'QQ';
                    PawPals.showToast(`${type}ç™»å½•åŠŸèƒ½å¼€å‘ä¸­...`);
                });
            });

            // å¿˜è®°å¯†ç é“¾æ¥
            const forgotPassword = document.querySelector('.forgot-password');
            forgotPassword.addEventListener('click', function(e) {
                e.preventDefault();
                PawPals.showToast('å¯†ç é‡ç½®åŠŸèƒ½å¼€å‘ä¸­...');
            });
        });
    </script>
</body>
</html>